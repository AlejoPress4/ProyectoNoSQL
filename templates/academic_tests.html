<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pruebas Acad√©micas - Sistema RAG NoSQL</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .test-card {
            border-left: 4px solid #007bff;
            transition: all 0.3s ease;
        }

        .test-card.success {
            border-left-color: #28a745;
            background-color: #d4edda;
        }

        .test-card.warning {
            border-left-color: #ffc107;
            background-color: #fff3cd;
        }

        .test-card.error {
            border-left-color: #dc3545;
            background-color: #f8d7da;
        }

        .result-box {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            max-height: 400px;
            overflow-y: auto;
        }

        .requirement-badge {
            background: #e3f2fd;
            color: #1976d2;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            margin: 0.25rem;
            display: inline-block;
        }

        .score-display {
            font-size: 2rem;
            font-weight: bold;
            color: #28a745;
        }
    </style>
</head>

<body>
    <div class="container mt-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-primary">
                    <div class="card-header bg-primary text-white">
                        <h1 class="mb-0"><i class="fas fa-university me-2"></i>Pruebas Acad√©micas - Sistema RAG NoSQL
                        </h1>
                        <p class="mb-0">Verificaci√≥n de cumplimiento con requisitos del proyecto final</p>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-3">
                                <h5>Puntuaci√≥n Total</h5>
                                <div class="score-display" id="totalScore">-/100</div>
                            </div>
                            <div class="col-md-3">
                                <h5>Estado</h5>
                                <span class="badge bg-secondary fs-6" id="projectStatus">Evaluando...</span>
                            </div>
                            <div class="col-md-3">
                                <h5>Calificaci√≥n</h5>
                                <div class="score-display" id="academicGrade">-</div>
                            </div>
                            <div class="col-md-3">
                                <h5>√öltima Prueba</h5>
                                <small id="lastTest">Nunca</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Botones de Acci√≥n -->
        <div class="row mb-4">
            <div class="col-12 text-center">
                <button class="btn btn-success btn-lg me-3" onclick="runAllAcademicTests()">
                    <i class="fas fa-play me-2"></i>Ejecutar Todas las Pruebas
                </button>
                <button class="btn btn-primary me-2" onclick="testSpecificRequirement('schema')">
                    Esquema NoSQL
                </button>
                <button class="btn btn-warning me-2" onclick="testSpecificRequirement('rag')">
                    Pipeline RAG
                </button>
                <button class="btn btn-info me-2" onclick="testSpecificRequirement('api')">
                    APIs REST
                </button>
                <button class="btn btn-outline-secondary" onclick="generateReport()">
                    <i class="fas fa-download me-2"></i>Generar Reporte
                </button>
            </div>
        </div>

        <!-- Casos de Prueba Obligatorios -->
        <div class="row">
            <div class="col-12">
                <h2><i class="fas fa-clipboard-check me-2"></i>Casos de Prueba Obligatorios</h2>
                <p class="text-muted">Estos son los casos espec√≠ficos requeridos por el documento acad√©mico</p>
            </div>
        </div>

        <!-- Test 1: B√∫squeda Sem√°ntica -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="card test-card" id="test1-card">
                    <div class="card-header">
                        <h5><i class="fas fa-search me-2"></i>1. B√∫squeda Sem√°ntica</h5>
                        <span class="requirement-badge">Requisito: Procesamiento de texto + embeddings</span>
                    </div>
                    <div class="card-body">
                        <p><strong>Consulta Obligatoria:</strong> "¬øQu√© productos hablan sobre tecnolog√≠a m√≥vil?"</p>
                        <div class="input-group mb-3">
                            <label for="semanticQuery" class="visually-hidden">Consulta de b√∫squeda sem√°ntica</label>
                            <input type="text" class="form-control" id="semanticQuery"
                                value="¬øQu√© productos hablan sobre tecnolog√≠a m√≥vil?"
                                placeholder="Ingresa tu consulta sem√°ntica"
                                aria-label="Campo de consulta para b√∫squeda sem√°ntica">
                            <button class="btn btn-outline-primary" onclick="testSemanticSearch()">
                                <i class="fas fa-search me-2"></i>Probar
                            </button>
                        </div>
                        <div id="semanticResults" class="result-box" style="display: none;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Test 2: Filtros H√≠bridos -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="card test-card" id="test2-card">
                    <div class="card-header">
                        <h5><i class="fas fa-filter me-2"></i>2. Filtros H√≠bridos</h5>
                        <span class="requirement-badge">Requisito: Filtros tradicionales + vectorial</span>
                    </div>
                    <div class="card-body">
                        <p><strong>Consulta Obligatoria:</strong> "Smartphones en stock con precio menor a $800"</p>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="hybridCategory" class="form-label">Categor√≠a:</label>
                                <select class="form-select" id="hybridCategory" aria-label="Seleccionar categor√≠a de productos">
                                    <option value="">Todas</option>
                                    <option value="smartphones">Smartphones</option>
                                    <option value="laptops">Laptops</option>
                                    <option value="tablets">Tablets</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="hybridMaxPrice" class="form-label">Precio M√°ximo:</label>
                                <input type="number" class="form-control" id="hybridMaxPrice" value="800"
                                    placeholder="Precio m√°ximo" aria-label="Precio m√°ximo en USD">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="hybridQuery" class="form-label">B√∫squeda Textual:</label>
                            <input type="text" class="form-control" id="hybridQuery" value="smartphone en stock"
                                placeholder="T√©rminos de b√∫squeda"
                                aria-label="Campo de t√©rminos de b√∫squeda textual">
                        </div>
                        <button class="btn btn-outline-warning" onclick="testHybridFilter()">
                            <i class="fas fa-filter me-2"></i>Probar Filtro H√≠brido
                        </button>
                        <div id="hybridResults" class="result-box" style="display: none;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Test 3: RAG Complejo -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="card test-card" id="test3-card">
                    <div class="card-header">
                        <h5><i class="fas fa-robot me-2"></i>3. RAG Complejo</h5>
                        <span class="requirement-badge">Requisito: LLM + contexto recuperado</span>
                    </div>
                    <div class="card-body">
                        <p><strong>Consulta Obligatoria:</strong> "Explica las principales caracter√≠sticas de los
                            mejores smartphones seg√∫n las rese√±as"</p>
                        <div class="input-group mb-3">
                            <label for="ragQuery" class="visually-hidden">Consulta RAG</label>
                            <input type="text" class="form-control" id="ragQuery"
                                value="Explica las principales caracter√≠sticas de los mejores smartphones seg√∫n las rese√±as"
                                placeholder="Ingresa tu consulta RAG"
                                aria-label="Campo de consulta para generaci√≥n RAG">
                            <button class="btn btn-outline-success" onclick="testRAGComplex()">
                                <i class="fas fa-robot me-2"></i>Probar RAG
                            </button>
                        </div>
                        <div id="ragResults" class="result-box" style="display: none;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Test 4: Validaci√≥n de Esquema NoSQL -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="card test-card" id="test4-card">
                    <div class="card-header">
                        <h5><i class="fas fa-database me-2"></i>4. Esquema NoSQL</h5>
                        <span class="requirement-badge">Requisito: Embedding vs Referencing</span>
                    </div>
                    <div class="card-body">
                        <p><strong>Validaci√≥n:</strong> Verificar estrategias de modelado NoSQL</p>
                        <button class="btn btn-outline-info" onclick="testNoSQLSchema()">
                            <i class="fas fa-database me-2"></i>Validar Esquema
                        </button>
                        <div id="schemaResults" class="result-box" style="display: none;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Test 5: APIs REST -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="card test-card" id="test5-card">
                    <div class="card-header">
                        <h5><i class="fas fa-cloud me-2"></i>5. APIs REST</h5>
                        <span class="requirement-badge">Requisito: POST /search y POST /rag</span>
                    </div>
                    <div class="card-body">
                        <p><strong>Validaci√≥n:</strong> Probar endpoints requeridos</p>
                        <button class="btn btn-outline-dark" onclick="testAPIEndpoints()">
                            <i class="fas fa-cloud me-2"></i>Probar APIs
                        </button>
                        <div id="apiResults" class="result-box" style="display: none;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Log de Resultados -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-list me-2"></i>Log de Pruebas</h5>
                    </div>
                    <div class="card-body">
                        <div id="testLog"
                            style="height: 300px; overflow-y: auto; font-family: monospace; font-size: 0.9rem;">
                            <div class="text-muted">Esperando pruebas...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let testScore = 0;
        let totalTests = 5;

        function logMessage(message, type = 'info') {
            const log = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                'success': 'text-success',
                'error': 'text-danger',
                'warning': 'text-warning',
                'info': 'text-info'
            };

            log.innerHTML += `<div class="${colors[type] || 'text-dark'}">[${timestamp}] ${message}</div>`;
            log.scrollTop = log.scrollHeight;
        }

        function updateTestCard(cardId, status) {
            const card = document.getElementById(cardId);
            card.className = `card test-card ${status}`;
        }

        function updateScore(points = 0) {
            if (points > 0) testScore += points;
            const percentage = (testScore / (totalTests * 20)) * 100;

            document.getElementById('totalScore').textContent = `${testScore}/${totalTests * 20}`;

            if (percentage >= 90) {
                document.getElementById('projectStatus').className = 'badge bg-success fs-6';
                document.getElementById('projectStatus').textContent = 'Sobresaliente';
                document.getElementById('academicGrade').textContent = '9.0-10.0';
            } else if (percentage >= 80) {
                document.getElementById('projectStatus').className = 'badge bg-primary fs-6';
                document.getElementById('projectStatus').textContent = 'Notable';
                document.getElementById('academicGrade').textContent = '8.0-8.9';
            } else if (percentage >= 70) {
                document.getElementById('projectStatus').className = 'badge bg-warning fs-6';
                document.getElementById('projectStatus').textContent = 'Bien';
                document.getElementById('academicGrade').textContent = '7.0-7.9';
            } else if (percentage >= 60) {
                document.getElementById('projectStatus').className = 'badge bg-info fs-6';
                document.getElementById('projectStatus').textContent = 'Aprobado';
                document.getElementById('academicGrade').textContent = '6.0-6.9';
            } else {
                document.getElementById('projectStatus').className = 'badge bg-danger fs-6';
                document.getElementById('projectStatus').textContent = 'Suspenso';
                document.getElementById('academicGrade').textContent = '0.0-5.9';
            }

            document.getElementById('lastTest').textContent = new Date().toLocaleString();
        }

        // Funci√≥n para renderizar productos                               function renderProductCard(producto) {
            c                            to.imagen_principal ? 
                `<img src="${produc                            " 
                                                                         style="height: 150px; object-fit: cover                                        {producto.nombre}" 
                     onerro                    a:im                    64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjE1MCIg                MCAwIDIwMC                      Im5vbmUiIH                    8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRo                    dD0iMTUwIiBmaWxs                    Cjx0ZXh0IHg9IjEwMCIgeT0iNzUiIHRl                    aWRkbGUiIGRvbWluYW50                    aWRkbGUiIGZpbGw9IiM2Yzc1N2Q                taWx5                Zm9udC1zaXp                uIGlt                dD4KPC9zdmc+';">` :
                       iv cl            d-img-top d-flex align-item             just            ent-center" style="height: 150px; background: #f8f9              i class="fas fa-ima                yle="font-size: 2rem;"></i>
                                 
            const marca = producto.marca?.nombre || 'Sin marca';
              const  cat            m bre || 'Sin cat e gor√≠            t preci o  = producto.precio_usd || 0;
            const calificacion = producto.calificacion || 0;
            const similitud = producto.similarity || 0;
            
            return `
                <div class="col-md-4 mb-3">
                    <div class="card h-100">
                        ${imagen}
                        <div class="card-body">
                            <h6 class="card-title">${producto.nombre}</h6>
                              <p class="card-t e                                                <strong>Marca:</strong> ${marca}<br>
                                  <strong>Categor√≠a:</strong> ${categoria}<br>
                                  <stron g >Precio:</s trong> $          g:</strong> ${calificacion}/5<br>
                                    <span class="badge bg-primary">Similitud: ${(similitud * 100).toF                pan>
                            </p>
                            </div>
                    </div>
                    </div>
            `;
        }ar                 lista de productos
        function renderProductsList(productos) {
            if (!productos || productos.length === 0) {
                return '<p>No se encontraron productos.</p>';
            }
            
            return `
                <div class="row">
                    ${productos.map(producto => renderProductCard(producto)).join('')}
                </div>
            `;
        }

        async function testSemanticSearch() {
            logMessage('üîç Iniciando prueba de b√∫squeda sem√°ntica...', 'info');
            const query = document.getElementById('semanticQuery').value;

            try {
                const response = await fetch('/api/products/search', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' },

                });

                if (response.ok) {
                    const data = await response.json();
                    updateTestCard('test1-card', 'success');
                    updateScore(20);

                    document.getElementById('semanticResults').style.display = 'block';
                    document.getElementById('semanticResults').innerHTML =
                         `<div class="mb-3">
                             <strong>‚úÖ B√∫squeda Sem√° ntica Exitosa</stro                            
                                                <small class="text-mute                                                         Productos encontrados: ${data.results?.lengt                                                                Tiempo: ${data.processing_time ||                                                                             </small>
                        </div>
                                                    ProductsList(data.results)}`;

                    logMessage('‚úÖ B√∫squeda sem√°ntica: APROBADA (20/20 puntos)', 'success');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                updateTestCard('test1-card', 'error');
                logMessage(`‚ùå B√∫squeda sem√°ntica: ERROR - ${error.message}`, 'error');

                document.getElementById('semanticResults').style.display = 'block';
                document.getElementById('semanticResults').innerHTML =
                    `<strong>‚ùå Error en B√∫squeda Sem√°ntica</strong><br>${error.message}`;
            }
        }

        async function testHybridFilter() {
            logMessage('üîç Iniciando prueba de filtros h√≠bridos...', 'info');

            try {
                const category = document.getElementById('hybridCategory').value;
                const maxPrice = document.getElementById('hybridMaxPrice').value;
                const query = document.getElementById('hybridQuery').value;

                const params = new URLSearchParams();
                if (query) params.append('query', query);
                if (category) params.append('category', category);
                if (maxPrice) params.append('max_price', maxPrice);

                const response = await fetch(`/api/products/search?${params}`);

                if (response.ok) {
                    const data = await response.json();
                    updateTestCard('test2-card', 'success');
                    updateScore(20);

                    document.getElementById('hybridResults').style.display = 'block';
                    document.getElementById('hybridResults').innerHTML =
                        `<div class="mb-3">
                            <strong>‚úÖ Filtros H√≠bridos Exitosos</strong><br>
                            <small class="text-muted">
                                Productos filtrados: ${data.results?.length || 0} | 
                                Filtros: Categor√≠a(${category || 'Todas'}), Precio(‚â§$${maxPrice || 'Sin l√≠mite'})
                            </small>
                        </div>
                        ${renderProductsList(data.results)}`;

                    logMessage('‚úÖ Filtros h√≠bridos: APROBADOS (20/20 puntos)', 'success');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                updateTestCard('test2-card', 'error');
                logMessage(`‚ùå Filtros h√≠bridos: ERROR - ${error.message}`, 'error');
            }
        }

        async function testRAGComplex() {
            logMessage('ü§ñ Iniciando prueba de RAG complejo...', 'info');
            const query = document.getElementById('ragQuery').value;

            try {
                const response = await fetch('/rag', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        query: query,
                        max_products: 5,
                        max_reviews: 3,
                        include_reviews: true
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    updateTestCard('test3-card', 'success');
                    updateScore(20);

                    document.getElementById('ragResults').style.display = 'block';
                    document.getElementById('ragResults').innerHTML =
                        `<div class="mb-3">
                            <strong>‚úÖ RAG Complejo Exitoso</strong><br>
                            <small class="text-muted">
                                Modelo: ${data.metadata?.model_used || 'N/A'} | 
                                Contexto: ${data.context?.total_productos || 0} productos, ${data.context?.total_resenas || 0} rese√±as | 
                                Tokens: ${data.metadata?.tokens_used || 'N/A'}
                            </small>
                        </div>
                        <div class="alert alert-info">
                            <strong>Respuesta RAG:</strong>
                            <div style="background: white; padding: 15px; border-radius: 8px; margin-top: 10px;">
                                ${data.rag_response || 'Sin respuesta'}
                            </div>
                        </div>
                         <details class= "mt-3">
                            <summary><strong>Ver productos del contexto</strong></summary>
                            <div class="mt-2">
                                ${renderProductsList(data.context?.productos || [])}
                            </div>
                        </details>`;

                    logMessage('‚úÖ RAG complejo: APROBADO (20/20 puntos)', 'success');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                updateTestCard('test3-card', 'error');
                logMessage(`‚ùå RAG complejo: ERROR - ${error.message}`, 'error');
            }
        }

        async function testNoSQLSchema() {
            logMessage('üìä Validando esquema NoSQL...', 'info');

            try {
                const response = await fetch('/api/stats');

                if (response.ok) {
                    const data = await response.json();
                    updateTestCard('test4-card', 'success');
                    updateScore(20);

                    document.getElementById('schemaResults').style.display = 'block';
                    document.getElementById('schemaResults').innerHTML =
                        `<strong>‚úÖ Esquema NoSQL Validado</strong>
                         <br>Estrategias implementadas:
                         <br>‚Ä¢ Embedding: Marcas embebidas en productos
                         <br>‚Ä¢ Referencing: Categor√≠as referenciadas
                         <br>‚Ä¢ H√≠brido: Metadatos + referencias
                         <br><pre>${JSON.stringify(data, null, 2)}</pre>`;

                    logMessage('‚úÖ Esquema NoSQL: APROBADO (20/20 puntos)', 'success');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                updateTestCard('test4-card', 'warning');
                updateScore(10);
                logMessage(`‚ö†Ô∏è Esquema NoSQL: PARCIAL - ${error.message} (10/20 puntos)`, 'warning');
            }
        }

        async function testAPIEndpoints() {
            logMessage('üåê Probando endpoints de API REST...', 'info');

            let apiScore = 0;
            const endpoints = [
                { url: '/api/products', method: 'GET', name: 'Productos' },
                { url: '/api/categories', method: 'GET', name: 'Categor√≠as' },
                { url: '/api/stats', method: 'GET', name: 'Estad√≠sticas' }
            ];

            let results = '<strong>Resultados de APIs:</strong><br>';

            for (const endpoint of endpoints) {
                try {
                    const response = await fetch(endpoint.url);
                    if (response.ok) {
                        apiScore += 5;
                        results += `‚úÖ ${endpoint.name}: OK<br>`;
                    } else {
                        results += `‚ùå ${endpoint.name}: Error ${response.status}<br>`;
                    }
                } catch (error) {
                    results += `‚ùå ${endpoint.name}: ${error.message}<br>`;
                }
            }

            if (apiScore >= 15) {
                updateTestCard('test5-card', 'success');
                updateScore(20);
                logMessage('‚úÖ APIs REST: APROBADAS (20/20 puntos)', 'success');
            } else {
                updateTestCard('test5-card', 'warning');
                updateScore(apiScore);
                logMessage(`‚ö†Ô∏è APIs REST: PARCIAL (${apiScore}/20 puntos)`, 'warning');
            }

            document.getElementById('apiResults').style.display = 'block';
            document.getElementById('apiResults').innerHTML = results;
        }

        async function runAllAcademicTests() {
            logMessage('üéì INICIANDO VALIDACI√ìN ACAD√âMICA COMPLETA', 'info');
            testScore = 0;

            await testSemanticSearch();
            await new Promise(resolve => setTimeout(resolve, 1000));

            await testHybridFilter();
            await new Promise(resolve => setTimeout(resolve, 1000));

            await testRAGComplex();
            await new Promise(resolve => setTimeout(resolve, 1000));

            await testNoSQLSchema();
            await new Promise(resolve => setTimeout(resolve, 1000));

            await testAPIEndpoints();

            logMessage('üèÜ VALIDACI√ìN ACAD√âMICA COMPLETADA', 'success');

            const finalScore = (testScore / (totalTests * 20)) * 100;
            if (finalScore >= 80) {
                logMessage(`üéâ PROYECTO APROBADO CON ${finalScore.toFixed(1)}%`, 'success');
            } else {
                logMessage(`‚ö†Ô∏è Proyecto necesita mejoras: ${finalScore.toFixed(1)}%`, 'warning');
            }
        }

        function generateReport() {
            const report = {
                timestamp: new Date().toISOString(),
                score: testScore,
                maxScore: totalTests * 20,
                percentage: (testScore / (totalTests * 20)) * 100,
                tests: {
                    semantic_search: document.getElementById('test1-card').classList.contains('success'),
                    hybrid_filters: document.getElementById('test2-card').classList.contains('success'),
                    rag_complex: document.getElementById('test3-card').classList.contains('success'),
                    nosql_schema: document.getElementById('test4-card').classList.contains('success'),
                    api_rest: document.getElementById('test5-card').classList.contains('success')
                }
            };

            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `academic_test_report_${new Date().toISOString().split('T')[0]}.json`;
            a.click();

            logMessage('üìÅ Reporte acad√©mico descargado', 'success');
        }

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function () {
            logMessage('üöÄ Sistema de pruebas acad√©micas inicializado', 'info');
            logMessage('üìö Proyecto: Sistema RAG NoSQL con MongoDB', 'info');
        });
    </script>
</body>

</html>